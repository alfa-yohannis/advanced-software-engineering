# docker-compose.yml
# Minimal local stack for the TTS case study:
# - api (FastAPI + Redis queue/state)
# - web (GET-only player + MP3 serving from MinIO)
# - worker (Piper + ffmpeg synth -> MP3 -> MinIO)
# - redis (queue/state)
# - minio (S3-compatible object storage)
#
# Assumptions:
# - services/api has: apiclear.py, requirements.txt, Dockerfile
# - services/web has: web.py, requirements.txt, Dockerfile, static/index.html
# - services/worker has: worker.py, requirements.txt, Dockerfile
# - worker image must contain piper binary + a model at /models/en_US.onnx
#   (either baked into the image or mounted via ./models)

services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  minio:
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"   # S3 API
      - "9001:9001"   # Console UI
    volumes:
      - minio_data:/data

  api:
    build:
      context: ./services/api
    environment:
      APP_ENV: dev
      REDIS_URL: redis://redis:6379/0
      MP3_BUCKET: tts-dev
      PUBLIC_BASE_URL: ""          # leave empty for relative /mp3/.. (served by web)
      INTERNAL_TOKEN: changeme
    depends_on:
      - redis
    ports:
      - "8000:8000"   # direct API access (optional; web also routes /api)
    # healthcheck (optional)
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8000/healthz"]
      interval: 10s
      timeout: 3s
      retries: 10

  web:
    build:
      context: ./services/web
    environment:
      APP_ENV: dev
      # Web serves MP3 from MinIO
      S3_ENDPOINT: http://minio:9000
      S3_ACCESS_KEY: minioadmin
      S3_SECRET_KEY: minioadmin
      S3_REGION: us-east-1
      MP3_BUCKET: tts-dev
      # Web JS calls API at /api (we map that using nginx below), but if you
      # run web directly on :8080 without nginx, you can still call API at :8000 by CORS.
    depends_on:
      - minio
    ports:
      - "8080:8000"   # open web UI at http://localhost:8080

  # Optional lightweight reverse proxy to keep same-origin:
  # - http://localhost:8088/      -> web
  # - http://localhost:8088/api/* -> api
  #
  # If you prefer not to use this, just use web on :8080 and API on :8000.
  gateway:
    image: nginx:1.27-alpine
    depends_on:
      - api
      - web
    ports:
      - "8088:80"
    volumes:
      - ./gateway/nginx.conf:/etc/nginx/conf.d/default.conf:ro

  worker:
    build:
      context: ./services/worker
    environment:
      APP_ENV: dev
      REDIS_URL: redis://redis:6379/0
      QUEUE_KEY: jobs:queue:dev
      API_BASE_URL: http://api:8000
      INTERNAL_TOKEN: changeme

      S3_ENDPOINT: http://minio:9000
      S3_ACCESS_KEY: minioadmin
      S3_SECRET_KEY: minioadmin
      S3_REGION: us-east-1
      MP3_BUCKET: tts-dev

      # Piper settings
      PIPER_MODEL_PATH: /models/en_GB-alan-medium.onnx
      PIPER_MODEL_CONFIG_PATH: /models/en_GB-alan-medium.onnx.json
      PIPER_LENGTH_SCALE: "1.0"
    depends_on:
      - redis
      - minio
      - api
    deploy:
      replicas: 1

volumes:
  minio_data:
